class GhostlineApp {
  constructor() {
    this.books = [
      { id: 'book1', title: 'OMNIA IAM FACTA SUNT', file: 'books/book1.html' },
      { id: 'book2', title: 'PA≈†NIK, MORJE IN STVAR', file: 'books/book2.html' },
      { id: 'book3', title: 'MESTO BREZ KRIVCEV', file: 'books/book3.html' }
    ];
    
    this.currentBook = 'book1';
    this.initialize();
  }
  
  initialize() {
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
    
    // Load navigation
    this.renderNav();
    
    // Load initial book
    this.loadBook(this.currentBook);
    
    // Setup event listeners
    this.setupEvents();
    
    // Start system monitor
    this.startSystemMonitor();
  }
  
  renderNav() {
    const nav = document.getElementById('ghost-nav');
    if (!nav) return;
    
    let html = '<h1>üúÇ GHOSTCORE</h1>';
    
    this.books.forEach(book => {
      const active = book.id === this.currentBook ? 'active' : '';
      html += `
        <a href="#" class="nav-item ${active}" data-book="${book.id}">
          <span class="symbol">üìò</span> ${book.title}
        </a>
      `;
    });
    
    // Add tools
    html += '<div style="margin-top: 3rem;">';
    html += '<h3>TOOLS</h3>';
    html += '<a href="#" class="nav-item" data-tool="search">üîç Search</a>';
    html += '<a href="#" class="nav-item" data-tool="export">üì§ Export</a>';
    html += '<a href="#" class="nav-item" data-tool="stats">üìä Stats</a>';
    html += '</div>';
    
    nav.innerHTML = html;
  }
  
  async loadBook(bookId) {
    const book = this.books.find(b => b.id === bookId);
    if (!book) return;
    
    this.currentBook = bookId;
    
    try {
      const response = await fetch(book.file);
      const content = await response.text();
      
      document.getElementById('book-content').innerHTML = content;
      this.renderNav(); // Update active state
      
      // Update URL without reload
      history.pushState({ book: bookId }, '', `?book=${bookId}`);
      
      // Log to system monitor
      this.logSystem(`Loaded: ${book.title}`);
    } catch (error) {
      console.error('Failed to load book:', error);
      document.getElementById('book-content').innerHTML = `
        <div class="error">
          <h2>‚ö†Ô∏è Error Loading Book</h2>
          <p>${error.message}</p>
          <p>Try refreshing or check console.</p>
        </div>
      `;
    }
  }
  
  setupEvents() {
    // Navigation clicks
    document.addEventListener('click', (e) => {
      if (e.target.closest('.nav-item')) {
        e.preventDefault();
        const bookId = e.target.closest('.nav-item').dataset.book;
        if (bookId) {
          this.loadBook(bookId);
        }
      }
    });
    
    // Handle browser back/forward
    window.addEventListener('popstate', (e) => {
      if (e.state && e.state.book) {
        this.loadBook(e.state.book);
      }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl+1,2,3 for book switching
      if (e.ctrlKey && e.key >= '1' && e.key <= '3') {
        const index = parseInt(e.key) - 1;
        if (this.books[index]) {
          this.loadBook(this.books[index].id);
        }
      }
      
      // Ctrl+S for search
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        this.showSearch();
      }
    });
  }
  
  showSearch() {
    const query = prompt('Search across all books:');
    if (query) {
      this.logSystem(`Searching for: "${query}"`);
      // Implement search logic here
    }
  }
  
  startSystemMonitor() {
    // Update system status every 10 seconds
    setInterval(() => {
      const memory = performance.memory ? 
        ` | RAM: ${Math.round(performance.memory.usedJSHeapSize / 1024 / 1024)}MB` : '';
      
      document.getElementById('system-status').textContent = 
        `STATUS: OPERATIONAL${memory} | ${new Date().toLocaleTimeString()}`;
    }, 10000);
  }
  
  logSystem(message) {
    console.log(`[GHOSTCORE] ${message}`);
    const log = document.getElementById('system-log');
    if (log) {
      const entry = document.createElement('div');
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      log.appendChild(entry);
    }
  }
}

// Initialize app when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  window.app = new GhostlineApp();
});
