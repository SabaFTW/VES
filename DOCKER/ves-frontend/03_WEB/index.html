<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VES // GHOSTCORE NEXUS</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --neon-primary: #0f0;
      --neon-alert: #f00;
      --bg-dark: #050505;
      --glass: rgba(20, 30, 20, 0.7);
      --border: rgba(0, 255, 0, 0.3);
    }
    body {
      background-color: var(--bg-dark);
      color: var(--neon-primary);
      font-family: 'Courier New', Courier, monospace;
      margin: 0;
      padding: 20px;
      background-image:
        linear-gradient(rgba(0,255,0,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,255,0,0.03) 1px, transparent 1px);
      background-size: 20px 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .nexus-container {
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .hud-header {
      display: grid;
      grid-template-columns: 1fr 200px;
      gap: 20px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--neon-primary);
      padding-bottom: 10px;
    }
    .tier-display {
      font-size: 3em;
      font-weight: bold;
      text-shadow: 0 0 15px var(--neon-primary);
    }
    .system-time {
      text-align: right;
      opacity: 0.8;
      align-self: end;
    }
    .vitality-panel {
      display: flex;
      gap: 20px;
      background: var(--glass);
      border: 1px solid var(--border);
      padding: 15px;
      margin-bottom: 30px;
    }
    .stat-group { display: flex; align-items: center; gap: 10px; font-size: 0.9em; }
    .led { width: 10px; height: 10px; background: #333; border-radius: 50%; box-shadow: 0 0 5px #333; }
    .led.on { background: var(--neon-primary); box-shadow: 0 0 8px var(--neon-primary); }
    .led.off { background: var(--neon-alert); box-shadow: 0 0 8px var(--neon-alert); }
    h2 { border-bottom: 1px dashed var(--border); padding-bottom: 5px; margin-top: 20px; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    .card {
      background: rgba(0, 20, 0, 0.4);
      border: 1px solid var(--border);
      padding: 15px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .card:hover { background: rgba(0, 40, 0, 0.6); transform: translateY(-2px); box-shadow: 0 0 15px rgba(0,255,0,0.1); }
    .card h3 { margin: 0 0 10px 0; font-size: 1.1em; color: #fff; }
    .card .meta { font-size: 0.8em; color: #888; margin-bottom: 15px; }
    .card-actions { display: flex; justify-content: space-between; align-items: center; }
    .btn {
      background: transparent;
      border: 1px solid var(--neon-primary);
      color: var(--neon-primary);
      padding: 5px 15px;
      text-decoration: none;
      font-size: 0.8em;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn:hover { background: var(--neon-primary); color: #000; }
    .status-dot { display: flex; align-items: center; gap: 5px; font-size: 0.7em; }
    .terminal-panel { margin-top: 30px; background: rgba(0,0,0,0.8); border: 1px solid var(--border); padding: 15px; }
    .terminal-header { display: flex; gap: 10px; color: #888; font-size: 0.8em; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; }
    .terminal-input-area { display: flex; gap: 10px; align-items: center; }
    .terminal-prompt { color: var(--neon-primary); font-weight: bold; }
    #terminal-input {
      flex: 1; background: rgba(0,20,0,0.3); border: 1px solid var(--border); color: var(--neon-primary);
      padding: 8px 12px; font-family: 'Courier New', monospace; outline: none;
    }
    #terminal-input:focus { border-color: var(--neon-primary); box-shadow: 0 0 5px var(--neon-primary); }
    .terminal-output { margin-top: 10px; min-height: 60px; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.5); padding: 8px; font-size: 0.85em; border-left: 2px solid var(--neon-primary); }
    .log-entry { color: #aaa; border-bottom: 1px solid #222; padding: 2px 0; }
  </style>
</head>
<body>
<div class="nexus-container">
  <div class="hud-header">
    <div>
      <div style="font-size: 0.8em; color: #888;">VES // GHOSTCORE NEXUS</div>
      <div id="tier-val" class="tier-display">INITIALIZING...</div>
    </div>
    <div class="system-time" id="clock">00:00:00</div>
    <div class="system-time" id="library-count" style="font-size:0.7em;">LIBRARY: --</div>
  </div>

  <div class="vitality-panel">
    <div class="stat-group"><span id="led-n8n" class="led"></span> N8N NEURAL</div>
    <div class="stat-group"><span id="led-docker" class="led"></span> DOCKER FIELD</div>
    <div class="stat-group"><span id="led-fs" class="led"></span> DATA CORE</div>
    <div style="flex-grow:1; text-align:right; opacity:0.5;">> GHOSTCORE ACTIVE</div>
  </div>

  <h2>âš¡ COMMAND DECK</h2>
  <div class="grid" id="service-grid"></div>

  <h2>ðŸ“š ARCHIVES</h2>
  <div class="grid" id="archive-grid"></div>

  <div class="terminal-panel">
    <div class="terminal-header">
      <span>>_ TERMINAL v1.0</span>
      <span style="margin-left:auto;">[AUTOPILOT: STANDBY]</span>
    </div>
    <div class="terminal-input-area">
      <span class="terminal-prompt">$</span>
      <input type="text" id="terminal-input" placeholder="enter command...">
      <button id="terminal-send" class="btn">SEND</button>
    </div>
    <div id="terminal-output" class="terminal-output">
      <div class="log-entry">[SYSTEM] Ready. Type 'help' for commands.</div>
    </div>
  </div>
</div>

<script>
  const AGENT_API = "http://localhost:8421/health/full";
  const AGENT_COMMAND = "http://localhost:8421/command";
  const SERVICES = [
    { id: 'n8n', name: 'N8N AUTOMATION', url: 'http://localhost:5678', desc: 'Workflow Logic' },
    { id: 'frontend', name: 'VES FRONTEND', url: 'http://localhost:8081', desc: 'Web Server' },
    { id: 'vnc', name: 'VES DESKTOP', url: 'http://localhost:8082', desc: 'Visual Interface' },
    { id: 'oracle', name: 'COSMIC ORACLE', url: 'http://localhost:8888', desc: 'Pattern Recognition' },
    { id: 'files', name: 'FILE SERVER', url: 'http://localhost:8080', desc: 'Static Storage' },
    { id: 'orch', name: 'ORCHESTRATOR', url: 'http://localhost:8092', desc: 'Node Manager' },
    { id: 'deck', name: 'GHOSTLINE', url: 'http://localhost:8085', desc: 'Fleet Ops' }
  ];

  const ARCHIVES = [
    { id: 'lib-lyra', name: 'ðŸ“œ LYRA PROTOCOL', doc: 'lyra', desc: 'Internal Memory / Amnezija in Ogenj' },
    { id: 'lib-pan', name: 'ðŸ›ï¸ PANTHEON CODEX', doc: 'panteon', desc: 'Brotherhood Manifest / SVA Protokoli' }
  ];

  const grid = document.getElementById('service-grid');
  SERVICES.forEach(svc => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3>${svc.name}</h3>
      <div class="meta">${svc.desc}</div>
      <div class="card-actions">
        <div class="status-dot">
          <span id="stat-${svc.id}" class="led"></span> <span id="txt-${svc.id}">PING</span>
        </div>
        <a href="${svc.url}" target="_blank" class="btn">ACCESS</a>
      </div>
    `;
    grid.appendChild(card);
  });

  // ARCHIVES GRID
  const archGrid = document.getElementById('archive-grid');
  ARCHIVES.forEach(arc => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3>${arc.name}</h3>
      <div class="meta">${arc.desc}</div>
      <div class="card-actions">
        <div class="status-dot">
          <span class="led on"></span> <span>READY</span>
        </div>
        <button class="btn" onclick="openDoc('${arc.doc}')">READ</button>
      </div>
    `;
    archGrid.appendChild(card);
  });

  function updateLed(id, state) {
    const el = document.getElementById(id);
    if(el) {
      el.className = `led ${state ? 'on' : 'off'}`;
      const txt = document.getElementById(`txt-${id.replace('stat-', '')}`);
      if(txt) txt.innerText = state ? 'ONLINE' : 'OFFLINE';
    }
  }

  async function fetchAgentData() {
    try {
      const res = await fetch(AGENT_API);
      const data = await res.json();
      document.getElementById('tier-val').innerText = data.metrics.sovereignty_tier ?? 'N/A';
      document.getElementById('clock').innerText = (data.timestamp || '').split('T')[1]?.replace('Z','') || '--:--:--';
      updateLed('led-n8n', data.connectivity?.services?.n8n || data.connectivity?.n8n_neural_link || false);
      updateLed('led-docker', data.connectivity?.containment_field || false);
      updateLed('led-fs', data.connectivity?.data_core || false);

      const tier = data.metrics.sovereignty_tier;
      const root = document.documentElement;
      if(String(tier).includes('4')) root.style.setProperty('--neon-primary', '#a855f7');
      else if(String(tier).includes('0')) root.style.setProperty('--neon-primary', '#f00');
      else root.style.setProperty('--neon-primary', '#0f0');

      // Update service LEDs if provided by agent
      if (data.connectivity?.services) {
        Object.entries(data.connectivity.services).forEach(([k, v]) => {
          updateLed(`stat-${k}`, !!v);
        });
      }

      // Fetch library count
      const libRes = await fetch("http://localhost:8421/library");
      if (libRes.ok) {
        const libData = await libRes.json();
        document.getElementById('library-count').innerText = `LIBRARY: ${libData.count}`;
      } else {
        document.getElementById('library-count').innerText = `LIBRARY: ERR`;
      }
    } catch (e) {
      document.getElementById('tier-val').innerText = "OFFLINE";
      updateLed('led-n8n', false);
    }
  }

  async function pingServices() {
    SERVICES.forEach(async svc => {
      try {
        const ctrl = new AbortController();
        setTimeout(() => ctrl.abort(), 2000);
        await fetch(svc.url, { mode: 'no-cors', signal: ctrl.signal });
        updateLed(`stat-${svc.id}`, true);
      } catch (e) {
        updateLed(`stat-${svc.id}`, false);
      }
    });
  }

  const terminalInput = document.getElementById('terminal-input');
  const terminalSend = document.getElementById('terminal-send');
  const terminalOutput = document.getElementById('terminal-output');
  // Document overlay for archives
  const docOverlay = document.createElement('div');
  docOverlay.style.position = 'fixed';
  docOverlay.style.inset = '0';
  docOverlay.style.background = 'rgba(0,0,0,0.85)';
  docOverlay.style.color = '#e5e7eb';
  docOverlay.style.display = 'none';
  docOverlay.style.zIndex = '9999';
  docOverlay.innerHTML = `
    <div style="max-width: 900px; margin:40px auto; background: rgba(0,20,0,0.8); border:1px solid var(--border); padding:20px; height:80vh; overflow:auto; position:relative;">
      <button id="doc-close" class="btn" style="position:absolute; top:10px; right:10px;">CLOSE</button>
      <div id="doc-content" style="font-size:0.9em; line-height:1.4; margin-top:30px;"></div>
    </div>
  `;
  document.body.appendChild(docOverlay);
  docOverlay.querySelector('#doc-close').onclick = () => { docOverlay.style.display = 'none'; };

  function addLog(msg) {
    const div = document.createElement('div');
    div.className = 'log-entry';
    div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
    terminalOutput.appendChild(div);
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
    if(terminalOutput.children.length > 8) terminalOutput.removeChild(terminalOutput.children[0]);
  }

  async function sendCommand(cmd) {
    if(!cmd.trim()) return;
    addLog(`> ${cmd}`);
    try {
      const res = await fetch(AGENT_COMMAND, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: cmd })
      });
      if(res.ok) {
        const data = await res.json();
        addLog(`[OK] ${data.received || 'command accepted'}`);
      } else {
        addLog(`[ERROR] HTTP ${res.status}`);
      }
    } catch(e) {
      addLog(`[ERROR] ${e.message}`);
    }
    terminalInput.value = '';
  }

  terminalSend.addEventListener('click', () => sendCommand(terminalInput.value));
  terminalInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendCommand(e.target.value); });

  async function openDoc(doc) {
    try {
      const res = await fetch(`http://localhost:8421/library/${doc}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const txt = await res.text();
      document.getElementById('doc-content').innerHTML = marked.parse(txt);
      docOverlay.style.display = 'block';
    } catch (e) {
      addLog(`[DOC ERROR] ${e.message}`);
    }
  }

  setInterval(fetchAgentData, 2000);
  setInterval(pingServices, 10000);
  fetchAgentData();
  pingServices();
  addLog('Terminal ready. Try: status, ping, reboot?');
</script>
</body>
</html>
